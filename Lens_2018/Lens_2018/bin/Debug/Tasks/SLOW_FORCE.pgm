DVAR $FORCE,$DELTA,$TIME,$INC,$SPEED,$SCALE
DVAR $IFORCE,$DFORCE,$JUDGE,$IPOS,$CPOS
DVAR $NFORCE
DVAR $FORCEINC[9]
DVAR $FORCETIME[9]
DVAR $COUNT

$FORCE=$GLOBAL[16]
$DELTA=$GLOBAL[17]
$TIME=$GLOBAL[18]
$INC=$GLOBAL[19]
$SPEED=$GLOBAL[20]
$SCALE=$GLOBAL[26]/10
$NFORCE=$GLOBAL[49]
$JUDGE=1
$COUNT=0

$FORCEINC[0]=$GLOBAL[50]
$FORCEINC[1]=$GLOBAL[51]
$FORCEINC[2]=$GLOBAL[52]
$FORCEINC[3]=$GLOBAL[53]
$FORCEINC[4]=$GLOBAL[54]
$FORCEINC[5]=$GLOBAL[55]
$FORCEINC[6]=$GLOBAL[56]
$FORCEINC[7]=$GLOBAL[57]
$FORCEINC[8]=$GLOBAL[58]

$FORCETIME[0]=$GLOBAL[59]
$FORCETIME[1]=$GLOBAL[60]
$FORCETIME[2]=$GLOBAL[61]
$FORCETIME[3]=$GLOBAL[62]
$FORCETIME[4]=$GLOBAL[63]
$FORCETIME[5]=$GLOBAL[64]
$FORCETIME[6]=$GLOBAL[65]
$FORCETIME[7]=$GLOBAL[66]
$FORCETIME[8]=$GLOBAL[67]

ACKNOWLEDGEALL

CRITICAL END
AUTOFOCUS Z OFF
VELOCITY OFF

INCREMENTAL

$IFORCE=$AI[0].Z
$IPOS=AXISSTATUS(Z,DATAITEM_PositionFeedback)

WHILE ($COUNT<$NFORCE)&&$JUDGE
   $CPOS=AXISSTATUS(Z,DATAITEM_PositionFeedback)
   $DFORCE=$AI[0].Z-$IFORCE
   
   IF($DFORCE*$SCALE>($FORCEINC[$COUNT]-$DELTA)) THEN
	  DWELL $FORCETIME[$COUNT]
	  $COUNT=$COUNT+1
   ELSEIF (($CPOS-$IPOS)>5) THEN
      $JUDGE=0
   ELSE
      RAPID Z$INC ZF$SPEED
   ENDIF
ENDWHILE

WHILE $JUDGE
   $CPOS=AXISSTATUS(Z,DATAITEM_PositionFeedback)
   $DFORCE=$AI[0].Z-$IFORCE
   
   IF($DFORCE*$SCALE>($FORCE-$DELTA)) THEN
      $JUDGE=0
   ELSEIF (($CPOS-$IPOS)>5) THEN
      $JUDGE=0
   ELSE
      RAPID Z$INC ZF$SPEED
   ENDIF
ENDWHILE

$GLOBAL[46]=$DFORCE*$SCALE

DWELL $TIME

END PROGRAM

