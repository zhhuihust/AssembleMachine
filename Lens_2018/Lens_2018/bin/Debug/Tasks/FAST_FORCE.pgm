DVAR $FORCE,$SPEED,$TIME,$SCALE
DVAR $DELTA,$JUDGE,$IFORCE,$DFORCE,$TCOUNT

'$FORCE=$GLOBAL[16]
'$SPEED=$GLOBAL[20]
'$TIME=$GLOBAL[18]
'$DELTA=$GLOBAL[17]
'$SCALE=$GLOBAL[26]/10
$JUDGE=1
$IFORCE=0
$DFORCE=0
$TCOUNT=0

$FORCE=2
$SPEED=100
$TIME=5
$DELTA=0.05
$SCALE=10

SETPARM Z AutofocusTarget $FORCE
SETPARM Z AutofocusGainKi2 0.01
SETPARM Z AutofocusSpeedClamp $SPEED
SETPARM Z, AutofocusDeadband 0.1
SETPARM Z, AutofocusGainKi 0
SETPARM Z, AutofocusGainKp 0
SETPARM Z, AutofocusLimitHigh 5
SETPARM Z, AutofocusLimitLow -5

ACKNOWLEDGEALL

CRITICAL END
AUTOFOCUS Z OFF
VELOCITY OFF

$IFORCE=$AI[0].Z

ABSOLUTE

AUTOFOCUS Z ON
WHILE $JUDGE
   DWELL 0.001
   $TCOUNT=$TCOUNT+0.001
   $DFORCE=$AI[0].Z-$IFORCE
   IF (($DFORCE>($FORCE-$DELTA))||($TCOUNT>3)) THEN
      ABORT Z
	  AUTOFOCUS Z OFF
	  $JUDGE=0
   ENDIF
ENDWHILE
ABORT Z
AUTOFOCUS Z OFF

$GLOBAL[46]=$DFORCE*$SCALE

DWELL $TIME


END PROGRAM


